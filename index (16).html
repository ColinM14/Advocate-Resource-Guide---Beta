<!--
The Advocate Dashboard - Dynamic Resource, Form, and Document Cards
--------------------------------------------------------------------
- Loads cards from data.json (see below for structure).
- Renders Resource, Form, and Document cards with features per card type.
- Supports search (including Notes), category favorites, and per-category copy.
- Implements copy/share (native or fallback) for relevant cards and bulk document actions.
- Inline code comments explain each part for maintainers.

DATA.JSON STRUCTURE (example entry):
[
  {
    "Home Page": true,
    "Type": "Resource" | "Form" | "Document",
    "Category": "CarePatrol Links",
    "Name": "Referral Form",
    "Website": "https://...",
    "Phone": "",
    "Description": "...",
    "Address": "",
    "Notes": ""
  },
  ...
]

CARD TYPE FEATURES:
-------------------
Resource Card:
- Name (heading)
- Visit Link button (opens Website)
- Website (as text)
- Phone Number
- Description
- Address
- Notes (displayed only, NEVER copied/shared)
- Copy Phone button (copies phone + description)
- Copy Website button (copies website + description)

Form Card:
- Name
- Description
- Visit Link button (opens Website)
- Copy Link button (copies name, link, description)

Document Card:
- Name
- Description
- Visit Document button
- Notes (displayed only, NEVER copied/shared)
- Checkbox for multi-select
- Bulk actions at page bottom:
    - Share Selected Links (native share/copy fallback; shares name, link, description)
    - Copy Links (copies name, link, description for all checked)

All:
- Search includes Name, Description, Category, and Notes.
- Favorites/star and clipboard icons per original design.
- All copy/share actions omit blank fields.
- All legacy category/copy/favorite features retained.

-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Advocate Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Telex&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: url('bg-tile.jpg');
      background-size: 400px 400px;
      padding-bottom: 30px;
    }
    header {
      background: #000;
      color: white;
      padding: 15px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    header img {
      width: 3in;
      max-width: 100%;
      display: block;
      margin: 0 auto;
    }
    header h1 {
      margin-top: 10px;
    }
    .page {
      display: none;
      padding: 15px 20px 15px 20px;
    }
    .visible {
      display: block;
    }
    .home-buttons {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin-top: 40px;
    }
    .home-buttons button {
      background: #715191;
      color: white;
      font-size: 18px;
      padding: 16px 32px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 280px;
    }
    .action-btn,
    .copy-button,
    .visit-link-button,
    .website-button,
    .visit-document-button,
    .share-button {
      display: inline-block;
      background: #715191;
      color: white;
      padding: 10px 16px;
      margin: 8px 4px 8px 0;
      border: none;
      border-radius: 4px;
      text-align: center;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
      min-width: 120px;
      min-height: 40px;
      vertical-align: middle;
      box-sizing: border-box;
    }
    .category-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    .category-block {
      width: calc(50% - 20px);
      box-sizing: border-box;
    }
    .category {
      width: 90%;
      margin: 5px auto;
      padding: 16px;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #009ca7;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 5px;
    }
    .category.active {
      background: #66b1e2;
    }
    .star-button {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: gold;
    }
    .resources-wrapper {
      display: none;
      margin-bottom: 20px;
    }
    .resource-card, .form-card, .document-card {
      background: white;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-top: 10px;
      margin-bottom: 10px;
      max-width: 600px;
    }
    .search-result-category {
      font-size: 16px;
      color: #555;
      margin-top: 25px;
      margin-bottom: -5px;
      padding-left: 10px;
      border-bottom: 2px solid #eee;
      padding-bottom: 5px;
    }
    .copy-button, .share-button {
      background: #66b1e2;
      color: white;
      border: none;
      padding: 10px 14px;
      margin-right: 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .share-button {
      background: #4caf50;
    }
    .action-button, .website-button, .visit-link-button, .visit-document-button {
      display: inline-block;
      background: #715191;
      color: white;
      padding: 10px 16px;
      margin: 12px 0;
      border: none;
      border-radius: 4px;
      text-align: center;
      font-weight: bold;
      cursor: pointer;
      text-decoration: none;
    }
    .back-button {
      position: sticky;
      background: #fff;
      padding: 12px;
      border-bottom: 2px solid #ccc;
      font-weight: bold;
      color: black;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
      top: 84px;
    }
    .card {
      background: white;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin: 20px auto;
      max-width: 600px;
    }
    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
    }
    .category-buttons {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .copy-category-button {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: white;
    }
    .search-bar {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .search-bar input {
      flex-grow: 1;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .search-bar button {
      padding: 10px 20px;
      font-size: 16px;
      background: #009ca7;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .document-checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      background-color: #f0f0f0;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 8px;
      margin-top: 10px;
      width: fit-content;
    }
    .document-checkbox-label input {
      width: 18px;
      height: 18px;
    }
    .copy-forms-container {
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100vw;
      padding: 15px;
      background-color: rgba(255, 255, 255, 0.95);
      border-top: 1px solid #ddd;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      display: flex;
      gap: 10px;
      z-index: 99999;
      justify-content: center;
      transition: opacity 0.2s;
    }
    .copy-forms-container.hide {
      display: none;
    }
    .copy-forms-container button {
      flex: 1;
      padding: 16px;
      font-size: 18px;
      font-weight: bold;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      max-width: 260px;
    }
    #shareSelectedDocs {
      background: #4caf50;
    }
    #copySelectedDocs {
      background: #715191;
    }
    .epiforge-footer {
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100%;
      background: rgba(211, 211, 211, 0.8);
      color: #222;
      text-align: center;
      font-family: 'Telex', sans-serif;
      padding: 6px 0;
      font-size: .75rem;
      letter-spacing: 1px;
      z-index: 9999;
    }
    body.child-page-padding {
      padding-bottom: 30px;
    }
    .notes-block {
      background: #f8f1ff;
      color: #55297a;
      padding: 8px;
      border-left: 4px solid #715191;
      margin-top: 12px;
      border-radius: 4px;
      font-size: 14px;
      font-style: italic;
    }
  </style>
</head>
<body>
<header id="main-header">
  <img src="https://carepatrol.com/wp-content/uploads/sites/2/2023/07/CP_CarePatrol-Logo_CMYK.svg" alt="CarePatrol Logo" />
  <h1>The Advocate Dashboard</h1>
</header>
<div id="home" class="page visible">
  <div class="home-buttons">
    <!-- Home category buttons inserted by JS -->
    <button onclick="showPage('resources')">Partner Network</button>
    <button onclick="showPage('search')">Search</button>
    <button onclick="showPage('favorites')">‚≠ê My Favorites</button>
  </div>
</div>
<div id="resources" class="page">
  <div class="back-button" onclick="showPage('home')">üè† Back to Home</div>
  <div id="resourceContent"></div>
</div>
<div id="forms" class="page">
  <div class="back-button" onclick="showPage('home')">üè† Back to Home</div>
  <div id="formContent"></div>
</div>
<div id="documents" class="page">
  <div class="back-button" onclick="showPage('home')">üè† Back to Home</div>
  <div id="documentContent"></div>
</div>
<div id="favorites" class="page">
  <div class="back-button" onclick="showPage('home')">üè† Back to Home</div>
  <div id="favoritesContent"></div>
</div>
<div id="search" class="page">
  <div class="back-button" onclick="showPage('home')">üè† Back to Home</div>
  <div class="card">
    <h3>Search Resources</h3>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search by name, category, description, notes...">
      <button id="searchButton">Search</button>
    </div>
  </div>
  <div id="searchResults"></div>
</div>
<div id="homeCategoryPage" class="page">
  <div class="back-button" onclick="showPage('home')">üè† Back to Home</div>
  <h2 id="homeCategoryHeading"></h2>
  <div id="homeCategoryContent"></div>
</div>
<!-- Bulk Document Share/Copy Footer -->
<div class="copy-forms-container hide" id="bulkDocFooter">
  <button id="shareSelectedDocs">Share Selected Documents</button>
  <button id="copySelectedDocs">Copy Documents</button>
</div>
<script>
let allResources = [];

// --- Utility: Omit blank fields from output ---
function omitBlankLines(obj) {
  return Object.entries(obj)
    .filter(([_, val]) => val && val.trim && val.trim() !== "")
    .map(([key, val]) => {
      if (key === "Name") return `Name: ${val}`;
      if (key === "Link") return `Link: ${val}`;
      if (key === "Description") return `Description: ${val}`;
      return `${key}: ${val}`;
    })
    .join('\n');
}

// --- Utility: Native share or fallback to copy/alert ---
function shareText(text, successMsg) {
  if (navigator.share) {
    navigator.share({ title: 'Shared Document(s)', text })
      .catch((error) => alert("Sharing failed or cancelled."));
  } else {
    navigator.clipboard.writeText(text).then(() => {
      alert(successMsg + "\n\n(Shared text copied to clipboard instead.)");
    });
  }
}

// --- Load resource data ---
fetch("data.json")
  .then(res => res.json())
  .then(data => {
    allResources = data;
    loadHomeButtons();
    if (document.getElementById('resourceContent')) loadResources();
    if (document.getElementById('formContent')) loadForms();
    if (document.getElementById('documentContent')) loadDocuments();
    setupBulkDocFooter();
  })
  .catch(error => console.error("Error fetching data:", error));

// --- NAVIGATION ---
function showPage(id) {
  document.querySelectorAll('.page').forEach(page => {
    page.classList.remove('visible');
  });
  document.getElementById(id).classList.add('visible');
  const pagesWithBottomButtons = ['forms', 'documents'];
  if (pagesWithBottomButtons.includes(id)) {
    document.body.classList.add('child-page-padding');
  } else {
    document.body.classList.remove('child-page-padding');
  }
  const pagesWithBackButton = ['resources', 'favorites', 'disclosures', 'forms', 'documents', 'search', 'homeCategoryPage'];
  if (pagesWithBackButton.includes(id)) {
    const header = document.getElementById('main-header');
    const backButton = document.querySelector(`#${id} .back-button`);
    if (header && backButton) {
      backButton.style.top = header.offsetHeight + 'px';
    }
  }
  if (id === 'resources') loadResources();
  if (id === 'favorites') loadFavorites();
  if (id === 'forms') loadForms();
  if (id === 'documents') loadDocuments();
  if (id === 'homeCategoryPage') {} // handled by showHomeCategoryPage
}

// --- COPY UTILITIES ---
function copyText(text) {
  navigator.clipboard.writeText(text).then(() => alert("Copied:\n" + text));
}
// Escapes any string so it can safely be included in JS attributes
function escapeForAttr(str) {
  if (!str) return '';
  return String(str)
    .replace(/\\/g, '\\\\')      // Escape backslash first
    .replace(/'/g, "\\'")        // Escape single quotes
    .replace(/"/g, '\\"')        // Escape double quotes
    .replace(/\r?\n/g, ' ')      // Remove newlines (optional: you can use '\\n' if you want literal newlines)
    .replace(/`/g, '\\`');       // Escape backticks (rare)
}

// --- CARD RENDERING FUNCTIONS ---
function createResourceCard(resource) {
  // If Document type, render as a document card (with checkbox)
  if(resource.Type === "Document") return createDocumentCard(resource);

  const card = document.createElement("div");
  card.className = "resource-card";
  const hasWebsite = resource.Website && resource.Website.trim() && resource.Website !== "null";
  const hasPhone = resource.Phone && resource.Phone.trim() && resource.Phone !== "null";
  const hasAddress = resource.Address && resource.Address.trim() && resource.Address !== "null";
  const hasDescription = resource.Description && resource.Description.trim() && resource.Description !== "null";
  const hasNotes = resource.Notes && resource.Notes.trim() && resource.Notes !== "null";

  card.innerHTML = `
    <h3>${escapeForAttr(resource.Name)}</h3>
    ${hasPhone ? `<div><strong>Phone:</strong> ${escapeForAttr(resource.Phone)}</div>` : ""}
    ${hasDescription ? `<div><strong>Description:</strong> ${escapeForAttr(resource.Description)}</div>` : ""}
    ${hasAddress ? `<div><strong>Address:</strong> ${escapeForAttr(resource.Address)}</div>` : ""}
    ${hasNotes ? `<div class="notes-block"><strong>Notes:</strong> ${escapeForAttr(resource.Notes)}</div>` : ""}
    <div class="button-row">
      ${hasPhone ? `
        <button class="action-btn copy-button"
          onclick="copyText('Name: ${escapeForAttr(resource.Name)}\\nPhone: ${escapeForAttr(resource.Phone)}${hasDescription ? '\\nDescription: ' + escapeForAttr(resource.Description) : ''}')"
        >Copy Phone</button>
      ` : ""}
      ${hasWebsite ? `
        <button class="action-btn copy-button"
          onclick="copyText('Name: ${escapeForAttr(resource.Name)}\\nWebsite: ${escapeForAttr(resource.Website)}${hasDescription ? '\\nDescription: ' + escapeForAttr(resource.Description) : ''}')"
        >Copy Website</button>
      ` : ""}
      ${hasWebsite ? `<button class="action-btn visit-link-button" onclick="window.open('${escapeForAttr(resource.Website)}', '_blank')">Visit Link</button>` : ""}
    </div>
  `;

  return card;
}
function createFormCard(resource) {
  const card = document.createElement("div");
  card.className = "form-card";
  const hasDescription = resource.Description && resource.Description.trim() && resource.Description !== "null";
  const hasNotes = resource.Notes && resource.Notes.trim() && resource.Notes !== "null";
  card.innerHTML = `
    <h3>${resource.Name}</h3>
    ${hasDescription ? `<div><strong>Description:</strong> ${resource.Description}</div>` : ""}
    <div class="button-row">
       <button class="action-btn visit-link-button" onclick="window.open('${resource.Website}', '_blank')">Visit Link</button>
      <button class="action-btn copy-button" onclick="copyText('${resource.Name}\\n${resource.Website}${hasDescription ? '\\n' + resource.Description.replace(/'/g,"\\'") : ''}')">Copy Link</button>
    </div>
    ${hasNotes ? `<div class="notes-block"><strong>Notes:</strong> ${resource.Notes}</div>` : ""}
  `;
  return card;
}

function createDocumentCard(resource, idx) {
  // Document card: always has checkbox, 'Visit Document', and bulk selection logic
  const card = document.createElement("div");
  card.className = "document-card";
  const hasDescription = resource.Description && resource.Description.trim() && resource.Description !== "null";
  const hasNotes = resource.Notes && resource.Notes.trim() && resource.Notes !== "null";
  // Use a unique ID for each checkbox (for event binding)
  const checkboxId = `doc-check-${resource.Category.replace(/\s+/g, '')}-${idx !== undefined ? idx : Math.floor(Math.random()*1000000)}`;
  card.innerHTML = `
    <label class="document-checkbox-label" for="${checkboxId}">
      <input type="checkbox" class="doc-checkbox" id="${checkboxId}" data-title="${encodeURIComponent(resource.Name)}" data-link="${encodeURIComponent(resource.Website||"")}" data-description="${encodeURIComponent(resource.Description||"")}">
      Select
    </label>
    <h3>${resource.Name}</h3>
    ${hasDescription ? `<div><strong>Description:</strong> ${resource.Description}</div>` : ""}
    <div class="button-row">
      <button class="action-btn visit-document-button" onclick="window.open('${resource.Website}', '_blank')">Visit Document</button>
    </div>
    ${hasNotes ? `<div class="notes-block"><strong>Notes:</strong> ${resource.Notes}</div>` : ""}
  `;
  // Checkbox event: handle show/hide of bulk footer
  setTimeout(() => {
    const checkbox = card.querySelector('.doc-checkbox');
    if (checkbox) checkbox.addEventListener('change', updateBulkDocFooterVisibility);
  }, 1);
  return card;
}

// --- PAGE LOADERS ---
function loadResources() {
  const container = document.getElementById("resourceContent");
  if (!container) return;
  container.innerHTML = '';
  const categories = [...new Set(allResources.map(item => item.Category))].sort();
  const row = document.createElement("div");
  row.className = "category-row";
  categories.forEach(cat => {
    const block = document.createElement("div");
    block.className = "category-block";
    const catDiv = document.createElement("div");
    catDiv.className = "category";
    const catLabel = document.createElement("span");
    catLabel.textContent = cat;
    const buttonGroup = document.createElement('div');
    buttonGroup.className = "category-buttons";
    const copyCatBtn = document.createElement("button");
    copyCatBtn.className = "copy-category-button";
    copyCatBtn.innerHTML = "üìã";
    copyCatBtn.title = "Copy all resources in this category";
    const itemsInCategory = allResources.filter(item => item.Category === cat);
    copyCatBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      let textToCopy = `Resources for ${cat}:\n\n`;
      itemsInCategory.forEach(item => {
        textToCopy += `Name: ${item.Name}\n`;
        if (item.Phone && item.Phone !== "null") textToCopy += `Phone: ${item.Phone}\n`;
        if (item.Address && item.Address !== "null") textToCopy += `Address: ${item.Address}\n`;
        if (item.Website && item.Website !== "null") textToCopy += `Website: ${item.Website}\n`;
        if (item.Description && item.Description !== "null") textToCopy += `Description: ${item.Description}\n`;
        textToCopy += `--------------------------------\n\n`;
      });
      navigator.clipboard.writeText(textToCopy.trim());
      alert(`Copied all resources for "${cat}"`);
    });
    const star = document.createElement("button");
    star.className = "star-button";
    star.innerHTML = isFavorite(cat) ? "‚òÖ" : "‚òÜ";
    star.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleFavorite(cat);
      star.innerHTML = isFavorite(cat) ? "‚òÖ" : "‚òÜ";
    });
    buttonGroup.appendChild(copyCatBtn);
    buttonGroup.appendChild(star);
    catDiv.appendChild(catLabel);
    catDiv.appendChild(buttonGroup);

    const wrapper = document.createElement("div");
    wrapper.className = "resources-wrapper";
    itemsInCategory
      .sort((a, b) => a.Name.localeCompare(b.Name))
      .forEach((item, idx) => {
        let cardElement;
        if (item.Type === "Resource") cardElement = createResourceCard(item);
        else if (item.Type === "Form") cardElement = createFormCard(item);
        else if (item.Type === "Document") cardElement = createDocumentCard(item, idx);
        if (cardElement) wrapper.appendChild(cardElement);
      });

    catDiv.addEventListener("click", () => {
      const isOpen = wrapper.style.display === "block";
      document.querySelectorAll(".resources-wrapper").forEach(w => w.style.display = "none");
      document.querySelectorAll(".category").forEach(c => c.classList.remove("active"));
      if (!isOpen) {
        wrapper.style.display = "block";
        catDiv.classList.add("active");
      }
    });

    block.appendChild(catDiv);
    block.appendChild(wrapper);
    row.appendChild(block);
  });
  container.appendChild(row);
  // Attach listeners to any new document checkboxes
  setTimeout(updateBulkDocFooterVisibility, 10);
}

function loadForms() {
  const container = document.getElementById("formContent");
  if (!container) return;
  container.innerHTML = '';
  const forms = allResources.filter(r => r.Type === "Form");
  if (forms.length === 0) {
    container.innerHTML = '<p>No forms available.</p>';
    return;
  }
  forms.forEach(resource => {
    const card = createFormCard(resource);
    container.appendChild(card);
  });
  setTimeout(updateBulkDocFooterVisibility, 10);
}

function loadDocuments() {
  const container = document.getElementById("documentContent");
  if (!container) return;
  container.innerHTML = '';
  const documents = allResources.filter(r => r.Type === "Document");
  if (documents.length === 0) {
    container.innerHTML = '<p>No documents available.</p>';
    return;
  }
  documents.forEach((resource, idx) => {
    const card = createDocumentCard(resource, idx);
    container.appendChild(card);
  });
  setTimeout(updateBulkDocFooterVisibility, 10);
}

function loadFavorites() {
  const container = document.getElementById("favoritesContent");
  container.innerHTML = "";
  const favs = getFavorites();
  if (favs.length === 0) {
    container.innerHTML = '<p style="text-align: center; margin-top: 20px;">You have no favorite categories yet.</p>';
    return;
  }
  const resources = allResources.filter(r => r.Type === "Resource");
  favs.forEach(cat => {
    const catDiv = document.createElement("div");
    catDiv.className = "category";
    const catLabel = document.createElement("span");
    catLabel.textContent = cat;
    const buttonGroup = document.createElement('div');
    buttonGroup.className = "category-buttons";
    const copyCatBtn = document.createElement("button");
    copyCatBtn.className = "copy-category-button";
    copyCatBtn.innerHTML = "üìã";
    copyCatBtn.title = "Copy all resources in this category";
    const sortedResources = resources.filter(item => item.Category === cat);
    copyCatBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      let textToCopy = `Resources for ${cat}:\n\n`;
      sortedResources.forEach(resource => {
        textToCopy += `Name: ${resource.Name}\n`;
        if (resource.Phone && resource.Phone !== "null") textToCopy += `Phone: ${resource.Phone}\n`;
        if (resource.Address && resource.Address !== "null") textToCopy += `Address: ${resource.Address}\n`;
        if (resource.Website && resource.Website !== "null") textToCopy += `Website: ${resource.Website}\n`;
        if (resource.Description && resource.Description !== "null") textToCopy += `Description: ${resource.Description}\n`;
        textToCopy += `--------------------------------\n\n`;
      });
      navigator.clipboard.writeText(textToCopy.trim());
      alert(`Copied all resources for "${cat}"`);
    });
    buttonGroup.appendChild(copyCatBtn);
    catDiv.appendChild(catLabel);
    catDiv.appendChild(buttonGroup);
    const wrapper = document.createElement("div");
    wrapper.className = "resources-wrapper";
    sortedResources
      .sort((a, b) => a.Name.localeCompare(b.Name))
      .forEach(resource => {
        const cardElement = createResourceCard(resource);
        wrapper.appendChild(cardElement);
      });
    catDiv.addEventListener("click", () => {
      const isOpen = wrapper.style.display === "block";
      document.querySelectorAll("#favoritesContent .resources-wrapper").forEach(w => w.style.display = "none");
      document.querySelectorAll("#favoritesContent .category").forEach(c => c.classList.remove("active"));
      if (!isOpen) {
        wrapper.style.display = "block";
        catDiv.classList.add("active");
      }
    });
    container.appendChild(catDiv);
    container.appendChild(wrapper);
  });
  setTimeout(updateBulkDocFooterVisibility, 10);
}

// --- FAVORITES ---
function getFavorites() {
  return JSON.parse(localStorage.getItem("favorites") || "[]");
}
function isFavorite(cat) {
  return getFavorites().includes(cat);
}
function toggleFavorite(cat) {
  let favs = getFavorites();
  if (favs.includes(cat)) {
    favs = favs.filter(c => c !== cat);
  } else {
    favs.push(cat);
  }
  localStorage.setItem("favorites", JSON.stringify(favs));
}

// --- SEARCH ---
function performSearch() {
  const searchInput = document.getElementById('searchInput');
  const resultsContainer = document.getElementById('searchResults');
  const searchTerm = searchInput.value.toLowerCase().trim();
  resultsContainer.innerHTML = '';
  if (!searchTerm) return;
  const searchResults = allResources.filter(resource => {
    const nameMatch = resource.Name && resource.Name.toLowerCase().includes(searchTerm);
    const descMatch = resource.Description && resource.Description.toLowerCase().includes(searchTerm);
    const catMatch = resource.Category && resource.Category.toLowerCase().includes(searchTerm);
    const notesMatch = resource.Notes && resource.Notes.toLowerCase().includes(searchTerm);
    return nameMatch || descMatch || catMatch || notesMatch;
  });
  if (searchResults.length > 0) {
    searchResults.forEach((resource, idx) => {
      const categoryHeader = document.createElement("h4");
      categoryHeader.className = "search-result-category";
      categoryHeader.textContent = `Category: ${resource.Category}`;
      let cardElement;
      if (resource.Type === "Resource") cardElement = createResourceCard(resource);
      else if (resource.Type === "Form") cardElement = createFormCard(resource);
      else if (resource.Type === "Document") cardElement = createDocumentCard(resource, idx);
      resultsContainer.appendChild(categoryHeader);
      resultsContainer.appendChild(cardElement);
    });
  } else {
    resultsContainer.innerHTML = '<p style="text-align: center; margin-top: 20px;">No results found.</p>';
  }
  setTimeout(updateBulkDocFooterVisibility, 10);
}

// --- HOME BUTTONS ---
function loadHomeButtons() {
  const homeDiv = document.querySelector('.home-buttons');
  homeDiv.innerHTML = `
    <button onclick="showPage('resources')">Partner Network</button>
    <button onclick="showPage('search')">Search</button>
    <button onclick="showPage('favorites')">‚≠ê My Favorites</button>
  `;
  const homeCategories = [
    ...new Set(
      allResources
        .filter(item => item["Home Page"] === true)
        .map(item => item.Category)
    )
  ];
  homeCategories.forEach(cat => {
    const btn = document.createElement('button');
    btn.textContent = cat;
    btn.onclick = () => {
      showHomeCategoryPage(cat);
    };
    homeDiv.appendChild(btn);
  });
}

function expandCategory(categoryName) {
  setTimeout(() => {
    document.querySelectorAll(".category").forEach(catDiv => {
      const label = catDiv.querySelector("span");
      if (label && label.textContent === categoryName) {
        catDiv.click();
        catDiv.scrollIntoView({behavior: "smooth", block: "start"});
      }
    });
  }, 250);
}
function showHomeCategoryPage(categoryName) {
  document.querySelectorAll('.page').forEach(page => page.classList.remove('visible'));
  document.getElementById('homeCategoryPage').classList.add('visible');
  document.getElementById('homeCategoryHeading').textContent = categoryName;
  const items = allResources.filter(item =>
    item.Category === categoryName && item["Home Page"] === true
  );
  const container = document.getElementById('homeCategoryContent');
  container.innerHTML = "";
  items
    .sort((a, b) => a.Name.localeCompare(b.Name))
    .forEach((item, idx) => {
      let cardElement;
      if (item.Type === "Resource") cardElement = createResourceCard(item);
      else if (item.Type === "Form") cardElement = createFormCard(item);
      else if (item.Type === "Document") cardElement = createDocumentCard(item, idx);
      if (cardElement) container.appendChild(cardElement);
    });
  setTimeout(updateBulkDocFooterVisibility, 10);
}

// --- Bulk Document Share/Copy Footer Logic ---
function setupBulkDocFooter() {
  // Attach event handlers for the sticky footer buttons
  const shareBtn = document.getElementById('shareSelectedDocs');
  const copyBtn = document.getElementById('copySelectedDocs');
  shareBtn.onclick = bulkShareDocuments;
  copyBtn.onclick = bulkCopyDocuments;
  updateBulkDocFooterVisibility();
}

function getAllCheckedDocumentCheckboxes() {
  return Array.from(document.querySelectorAll('.doc-checkbox:checked'));
}

function getBulkSelectedDocsText() {
  // Build the text block for all checked Document cards
  const checkedBoxes = getAllCheckedDocumentCheckboxes();
  let textToShare = "";
  checkedBoxes.forEach(box => {
    const name = decodeURIComponent(box.getAttribute("data-title") || "");
    const link = decodeURIComponent(box.getAttribute("data-link") || "");
    const desc = decodeURIComponent(box.getAttribute("data-description") || "");
    let entry = "";
    if (name) entry += `Name: ${name}\n`;
    if (link) entry += `Link: ${link}\n`;
    if (desc) entry += `Description: ${desc}\n`;
    if (entry) textToShare += entry + "\n";
  });
  return textToShare.trim();
}

function bulkShareDocuments() {
  const text = getBulkSelectedDocsText();
  if (!text) {
    alert("Please select one or more documents to share.");
    return;
  }
  shareText(text, "Links shared!");
  clearBulkDocCheckboxes();
  updateBulkDocFooterVisibility();
}

function bulkCopyDocuments() {
  const text = getBulkSelectedDocsText();
  if (!text) {
    alert("Please select one or more documents to copy.");
    return;
  }
  navigator.clipboard.writeText(text).then(() => {
    alert("Links copied to clipboard.");
    clearBulkDocCheckboxes();
    updateBulkDocFooterVisibility();
  });
}

function clearBulkDocCheckboxes() {
  const allBoxes = document.querySelectorAll('.doc-checkbox');
  allBoxes.forEach(box => { box.checked = false; });
}

function updateBulkDocFooterVisibility() {
  const checkedBoxes = getAllCheckedDocumentCheckboxes();
  const footer = document.getElementById('bulkDocFooter');
  if (!footer) return;
  if (checkedBoxes.length > 0) {
    footer.classList.remove('hide');
  } else {
    footer.classList.add('hide');
  }
}

// --- Enable search on Enter ---
document.addEventListener('DOMContentLoaded', () => {
  const searchButton = document.getElementById('searchButton');
  const searchInput = document.getElementById('searchInput');
  if (searchButton) searchButton.addEventListener('click', performSearch);
  if (searchInput) {
    searchInput.addEventListener('keyup', (event) => {
      if (event.key === 'Enter') performSearch();
    });
  }
});
</script>
<footer class="epiforge-footer">
  An <a href="https://theepiforge.com/" target="_blank" style="color:inherit;text-decoration:underline;">EpiForge</a> Product
</footer>
</body>
</html>
